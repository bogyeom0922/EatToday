{{>layout/header}}

{{#user}}
    <input type="hidden" id="new-like-userid" value="{{id}}">
{{/user}}
{{#rest}}
    <input type="hidden" id="new-like-store-id" value="{{id}}">
    <div class="image-container">
        <img src="{{store_img}}" class="rest_img" alt="ë§¤ì¥ ì´ë¯¸ì§€">
        <div class="title_background">
            <div class="store_name">
                {{store_name}}
            </div>
            <button class="review_link">ë” ì•Œì•„ë³´ê¸°</button>
        </div>
    </div>

    <div class="bookmark" id="like-{{id}}">
        <img id="bookmark_img" src="/img/bookmark_x.png" alt="ì¦ê²¨ì°¾ê¸°">
    </div>

    <div class="rest_detail">
        <table>
            <tr>
                <td style="width:25%;">ì˜ì—…ì‹œê°„</td>
                <td style="width:75%;">{{store_time}}</td>
            </tr>
            <tr>
                <td>ì£¼ì†Œ</td>
                <td id="storeAddress">{{store_address}}</td>
            </tr>
            <tr>
                <td>ëŒ€í‘œë²ˆí˜¸</td>
                <td>{{store_phone}}</td>
            </tr>
            <tr>
                <td>ë³„ì </td>
                <td>{{store_star}}</td>
            </tr>
            <tr>
                <td>ë©”ë‰´</td>
                <td>
                    <div id="MenuDisplay" class="rest_menu_list"></div>
                </td>
            </tr>
        </table>

        <div id="MenuSentence">
            {{store_menu}}
        </div>

        <div class="map_section">
            <button id="directionsButton" class="direction">ê¸¸ì°¾ê¸°</button>
            <div id="map" class="map"></div>
        </div>

        <div class="review">
            <p>ë¦¬ë·°</p>
            {{>review/_reviews}}
            <div class="rest_review_list">
                <div id="ReviewDisplay"></div>
            </div>
        </div>
        <br>
    </div>
    <div class="container">
        <h2>ì˜ˆì•½ ë‚ ì§œ ì„ íƒ</h2>
        <label for="reservationDate">ë‚ ì§œ ì„ íƒ:</label>
        <input type="text" id="reservationDate" name="reservationDate" readonly required>
        <button type="button" onclick="toggleCalendar()">ğŸ“… ë‚ ì§œ ì„ íƒ</button>

        <table id="calendar" class="calendar"></table>

        <div id="timePickerContainer" style="display: none;">
            <label for="timePicker">ì‹œê°„ ì„ íƒ:</label>
            <select id="timePicker" onchange="updateReservationDate()"></select>
        </div>

        <button id="reserve-button" type="submit">ì˜ˆì•½í•˜ê¸°</button>
    </div>
{{/rest}}

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{kakaoApiKey}}&libraries=services"></script>
<script>
    var address = document.getElementById('storeAddress').innerText.trim();

    var container = document.getElementById('map');
    var options = {
        center: new kakao.maps.LatLng(33.450701, 126.570667),
        level: 3
    };

    var map = new kakao.maps.Map(container, options);

    var geocoder = new kakao.maps.services.Geocoder();
    geocoder.addressSearch(address, function (result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(coords);

            var marker = new kakao.maps.Marker({
                map: map,
                position: coords,
                title: "ë§¤ì¥ ìœ„ì¹˜"
            });

        } else {
            console.error("ì¢Œí‘œë¡œ ë³€í™˜ ë„ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + address);
        }
    });

    //ê¸¸ì°¾ê¸°
    var destinationCoords = null;

    geocoder.addressSearch(address, function (result, status) {
        if (status === kakao.maps.services.Status.OK) {
            destinationCoords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(destinationCoords);
        } else {
            console.error("ì¢Œí‘œë¡œ ë³€í™˜ ë„ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + address);
        }
    });

    document.getElementById('directionsButton').addEventListener('click', function () {
        if (!destinationCoords) {
            alert("ë„ì°©ì§€ë¥¼ ë‹¤ì‹œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            return;
        }

        var kakaoMapURL = `https://map.kakao.com/link/to/ë„ì°©ì§€,${destinationCoords.getLat()},${destinationCoords.getLng()}`;

        // ìƒˆ ì°½ìœ¼ë¡œ ê¸¸ì°¾ê¸° ì—´ê¸°
        window.open(kakaoMapURL, '_blank');
    });
</script>

<script>
    function toggleCalendar() {
        let calendar = document.getElementById("calendar");
        calendar.style.display = (calendar.style.display === "none" || calendar.style.display === "") ? "table" : "none";
        if (calendar.innerHTML === "") {
            generateCalendar();
        }
    }

    let selectedDate = "";  // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œë¥¼ ì €ì¥í•  ë³€ìˆ˜

    function generateCalendar() {
        let calendar = document.getElementById("calendar");
        let today = new Date();
        let year = today.getFullYear();
        let month = today.getMonth();

        let firstDay = new Date(year, month, 1).getDay();
        let lastDate = new Date(year, month + 1, 0).getDate();

        let days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
        let html = "<tr>" + days.map(day => `<th>${day}</th>`).join("") + "</tr>";

        let date = 1;
        for (let i = 0; i < 6; i++) {
            let row = "<tr>";
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < firstDay) {
                    row += "<td></td>";
                } else if (date > lastDate) {
                    row += "<td></td>";
                } else {
                    row += `<td onclick="selectDate(${year}, ${month + 1}, ${date})">${date}</td>`;
                    date++;
                }
            }
            row += "</tr>";
            html += row;
            if (date > lastDate) break;
        }
        calendar.innerHTML = html;
    }

    function selectDate(year, month, day) {
        let reservationDate = document.getElementById("reservationDate");
        let timePickerContainer = document.getElementById("timePickerContainer");
        let timePicker = document.getElementById("timePicker");

        // ì„ íƒí•œ ë‚ ì§œ ì €ì¥ (YYYY-MM-DD í˜•ì‹)
        selectedDate = `${year}-${month.toString().padStart(2, "0")}-${day.toString().padStart(2, "0")}`;

        // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
        timePicker.innerHTML = "";

        // 1ì‹œê°„ ë‹¨ìœ„ë¡œ ì‹œê°„ ì˜µì…˜ ì¶”ê°€
        for (let hour = 0; hour < 24; hour++) {
            let time = `${hour.toString().padStart(2, "0")}:00`;
            let option = document.createElement("option");
            option.value = time;
            option.textContent = time;
            timePicker.appendChild(option);
        }

        // ì‹œê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
        timePickerContainer.style.display = "block";

        // ê¸°ë³¸ ì‹œê°„ ì„¤ì • í›„ inputì— ë°˜ì˜
        updateReservationDate();
    }

    function updateReservationDate() {
        let reservationDate = document.getElementById("reservationDate");
        let timePicker = document.getElementById("timePicker");

        if (selectedDate && timePicker.value) {
            reservationDate.value = `${selectedDate} ${timePicker.value}`;
        }
    }

    generateCalendar();

        document.getElementById('reserve-button').addEventListener('click', function () {
        const id = document.querySelector("#new-like-user-id").value;
        if(id){
            console.log(id);
        }
        else{
            console.log("null id")
        }

        const storeId = document.querySelector("#new-like-store-id").value;
        if(storeId)
            console.log(storeId);
        else{
            console.log("null storeid")
        }
        const reservationDate = document.getElementById('reservationDate').value;
        if(reservationDate)
            console.log(reservationDate);
        else{
            console.log("null date")
        }
        fetch("/reservation/register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                userId : id,
                storeId : storeId,
                reservationDate : reservationDate
            })
        }).then(response => {
            if (response.ok) {
                alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                alert("ì˜ˆì•½ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        });
    });

</script>

<script>
    document.querySelector('.review_link').addEventListener('click', function () {
        const target = document.querySelector('.rest_detail');
        target.scrollIntoView({behavior: 'smooth', block: 'start'});
    });
</script>

<!--menu-->
<script>

    const menu_str = document.getElementById("MenuSentence").textContent;
    const menu_arr = menu_str.split(", ");

    const MenuDisplay = document.getElementById("MenuDisplay");
    document.getElementById("MenuSentence").style.display = "none";

    menu_arr.forEach((menu, menu_index) => {
        let menu_text = menu.trim();
        if (menu_index === menu_arr.length - 1) {
            menu_text = menu_text.slice(0, -1);
        }
        MenuDisplay.append(menu_text);
        MenuDisplay.appendChild(document.createElement("br"));
    });

</script>

<!--like-->
<script type="text/javascript">
    let state = 0;
    const url = "/api/" + document.querySelector("#new-like-userid").value + "/" + document.querySelector("#new-like-store-id").value + "/likes";
    fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (data == null) {
                    document.getElementById('bookmark_img').src = "/img/bookmark_x.png";
                    state = 0;
                }
                document.getElementById('bookmark_img').src = "/img/bookmark_o.png";
                state = 1;
            }).catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });

    const likeCreate = document.getElementById('bookmark_img');
    likeCreate.addEventListener("click", function () {
        if (state === 0) {
            state = 1;
            document.getElementById('bookmark_img').src = "/img/bookmark_o.png";
            const like = {
                user_id: document.querySelector("#new-like-userid").value,
                store_id: document.querySelector("#new-like-store-id").value,
                like_state: 1,
            };
            const url = "/api/" + like.user_id + "/" + like.store_id + "/likes";
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(like)
            }).then(response => response.json())
                    .then(data => {
                        let like_id = data.id;
                        console.log("ìƒì„±ëœ ì¢‹ì•„ìš” id: " + like_id);
                        let like_state = data.state;
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("ì¢‹ì•„ìš” ìƒì„± ì‹¤íŒ¨");
                    });
        } else {
            document.getElementById('bookmark_img').src = "/img/bookmark_x.png";
            fetch("/api/likes/" + document.querySelector("#new-like-userid").value + "/" + document.querySelector("#new-like-store-id").value, {
                method: "DELETE"
            }).then(response => {
                if (!response.ok) {
                    alert("ì¢‹ì•„ìš” ì‚­ì œ ì‹¤íŒ¨");
                    console.log(document.querySelector("#new-like-userid").value);
                    console.log(document.querySelector("#new-like-store-id").value);
                    return;
                }
                const target = document.querySelector(`#like-` + document.querySelector("#new-like-store-id").value); // ìˆ˜ì •ëœ ë¶€ë¶„
                if (target) {
                    target.remove(); // ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ ì‚­ì œ
                    const msg = "ë§¤ì¥ ì•„ì´ë””:" + document.querySelector("#new-like-store-id").value + `ë²ˆ ì¦ê²¨ì°¾ê¸°ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤`;
                    alert(msg);
                    window.location.reload(true);
                } else {
                    console.error(`IDê°€ like-'+ document.querySelector("#new-like-store-id").value + 'ì¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            }).catch(error => {
                console.error('Error:', error);
                alert("ì¢‹ì•„ìš” ì‚­ì œ ì‹¤íŒ¨");

            });
        }
    });
</script>

</body>
</html>
